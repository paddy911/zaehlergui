name: Build AppImage
on:
  push:
    branches: [dev]
  pull_request:
    branches: [dev]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    
    steps:
      # -------------------------------------------------
      # 1Ô∏è‚É£ Cache (pacman & pip)
      # -------------------------------------------------
      - name: Cache pacman & pip
        uses: actions/cache@v4
        with:
          path: |
            /var/cache/pacman/pkg
            ~/.cache/pip
          key: ${{ runner.os }}-arch-pkg-${{ hashFiles('**/*.yml') }}
      
      # -------------------------------------------------
      # 2Ô∏è‚É£ Checkout des Repositories
      # -------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # -------------------------------------------------
      # 3Ô∏è‚É£ System-Abh√§ngigkeiten
      # -------------------------------------------------
      - name: Install system dependencies
        run: |
          pacman -Sy --noconfirm \
            base-devel \
            git \
            python-pip \
            python-gobject \
            gtk4 \
            patchelf \
            fuse2 \
            squashfs-tools \
            zsync \
            strace \
            wget
      
      # -------------------------------------------------
      # 4Ô∏è‚É£ Download und Installation von appimage-builder
      # -------------------------------------------------
      - name: Install appimage-builder
        run: |
          # Version festlegen
          APPIMG_BUILDER_VER="1.1.1"
          
          # Korrekte Download-URL (wichtig: /download/ statt /releases/download/)
          URL="https://github.com/AppImageCrafters/appimage-builder/releases/download/v${APPIMG_BUILDER_VER}/appimage-builder-${APPIMG_BUILDER_VER}-x86_64.AppImage"
          
          echo "üì• Downloading appimage-builder ${APPIMG_BUILDER_VER}..."
          
          # Mit wget und folgenden Weiterleitungen
          wget --no-verbose --show-progress \
            -O /tmp/appimage-builder.AppImage \
            "$URL"
          
          # Pr√ºfen, ob die Datei wirklich ein Binary ist
          if ! file /tmp/appimage-builder.AppImage | grep -q "ELF"; then
            echo "‚ùå Downloaded file is not an ELF binary!"
            echo "File content:"
            head -20 /tmp/appimage-builder.AppImage
            exit 1
          fi
          
          echo "‚úÖ Valid binary downloaded"
          chmod +x /tmp/appimage-builder.AppImage
          
          # Nach /usr/local/bin verschieben
          mv /tmp/appimage-builder.AppImage /usr/local/bin/appimage-builder
          
          # Verifizieren
          which appimage-builder || { echo "‚ùå appimage-builder not in PATH"; exit 1; }
          
          echo "‚úÖ appimage-builder installed successfully"
      
      # -------------------------------------------------
      # 5Ô∏è‚É£ Build des AppImages
      # -------------------------------------------------
      - name: Build AppImage
        run: |
          appimage-builder --recipe AppImageBuilder.yml
      
      # -------------------------------------------------
      # 6Ô∏è‚É£ Artefakt hochladen
      # -------------------------------------------------
      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: zaehlerstaende-appimage
          path: "*.AppImage"
