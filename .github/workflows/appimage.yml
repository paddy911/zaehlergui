name: Build AppImage

on:
  push:
    branches: [dev]          # oder dein Standard‑Branch
  pull_request:
    branches: [dev]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest   # Arch‑Container

    steps:
      # -------------------------------------------------
      # 1️⃣ Cache (pacman & pip)
      # -------------------------------------------------
      - name: Cache pacman & pip
        uses: actions/cache@v4
        with:
          path: |
            /var/cache/pacman/pkg
            ~/.cache/pip
          key: ${{ runner.os }}-arch-pkg-${{ hashFiles('**/*.yml') }}

      # -------------------------------------------------
      # 2️⃣ Checkout des Repositories
      # -------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------
      # 3️⃣ System‑Abhängigkeiten (für deine App)
      # -------------------------------------------------
      - name: Install system dependencies
        run: |
          pacman -Sy --noconfirm \
            base-devel \
            git \
            python-pip \
            python-gobject \
            gtk4 \
            patchelf \
            fuse2 \
            squashfs-tools \
            zsync \
            strace

      # -------------------------------------------------
      # 4️⃣ **Download** und installieren von appimage‑builder
      # -------------------------------------------------
      - name: Install appimage-builder (download binary)
        run: |
          # ----------- Welche Version wollen wir? ----------
          # Aktuell (Stand Januar 2026) ist 1.1.1 – du kannst
          # die URL bei Bedarf anpassen.
          APPIMG_BUILDER_VER="1.1.1"
          URL="https://github.com/AppImageCrafters/appimage-builder/releases/download/v${APPIMG_BUILDER_VER}/appimage-builder-${APPIMG_BUILDER_VER}-x86_64.AppImage"

          echo "Downloading appimage-builder ${APPIMG_BUILDER_VER} ..."
          curl -L -o /tmp/appimage-builder.AppImage "$URL"

          echo "Making it executable ..."
          chmod +x /tmp/appimage-builder.AppImage

          echo "Placing binary into /usr/local/bin ..."
          mv /tmp/appimage-builder.AppImage /usr/local/bin/appimage-builder

          # Kurzer Test, dass das Binary jetzt im PATH liegt
          which appimage-builder || { echo "❌ appimage-builder not found"; exit 1; }

      # -------------------------------------------------
      # 5️⃣ Build des eigentlichen AppImages
      # -------------------------------------------------
      - name: Build AppImage
        run: |
          appimage-builder --recipe AppImageBuilder.yml

      # -------------------------------------------------
      # 6️⃣ Artefakt hochladen
      # -------------------------------------------------
      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: zaehlerstaende-appimage
          path: "*.AppImage"