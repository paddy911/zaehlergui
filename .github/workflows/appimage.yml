name: Build AppImage

on:
  push:
    branches: [dev]
  pull_request:
    branches: [dev]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest

    steps:
      # -------------------------------------------------
      # 1Ô∏è‚É£ Cache (pacman & pip)
      # -------------------------------------------------
      - name: Cache pacman & pip
        uses: actions/cache@v4
        with:
          path: |
            /var/cache/pacman/pkg
            ~/.cache/pip
          key: ${{ runner.os }}-arch-pkg-${{ hashFiles('**/*.yml') }}

      # -------------------------------------------------
      # 2Ô∏è‚É£ Checkout des Repositories
      # -------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------
      # 3Ô∏è‚É£ System‚ÄëAbh√§ngigkeiten (f√ºr deine App)
      # -------------------------------------------------
      - name: Install system dependencies
        run: |
          pacman -Sy --noconfirm \
            base-devel \
            git \
            python-pip \
            python-gobject \
            gtk4 \
            patchelf \
            fuse2 \
            squashfs-tools \
            zsync \
            strace \
            wget

      # -------------------------------------------------
      # 4Ô∏è‚É£ Download und Installation von appimage‚Äëbuilder
      # -------------------------------------------------
      - name: Install appimage-builder
        run: |
          # ---- Version festlegen (neueste stabile) ----
          APPIMG_BUILDER_VER="1.1.1"
          URL="https://github.com/AppImageCrafters/appimage-builder/releases/download/v${APPIMG_BUILDER_VER}/appimage-builder-${APPIMG_BUILDER_VER}-x86_64.AppImage"

          echo "üì• Downloading appimage-builder ${APPIMG_BUILDER_VER} ..."
          wget -q --show-progress -O /tmp/appimage-builder.AppImage "$URL"

          # ---- sanity‚Äëcheck: muss ein ELF‚ÄëBinary sein ----
          if ! file /tmp/appimage-builder.AppImage | grep -q "ELF"; then
            echo "‚ùå Downloaded file is not an ELF binary!"
            head -20 /tmp/appimage-builder.AppImage
            exit 1
          fi

          chmod +x /tmp/appimage-builder.AppImage
          mv /tmp/appimage-builder.AppImage /usr/local/bin/appimage-builder

          which appimage-builder || { echo "‚ùå appimage-builder not in PATH"; exit 1; }
          echo "‚úÖ appimage-builder installed successfully"

      # -------------------------------------------------
      # 5Ô∏è‚É£ Build des AppImages (no‚Äëfuse mode)
      # -------------------------------------------------
      - name: Build AppImage (no‚Äëfuse)
        # Variante‚ÄØA: Umgebungsvariable
        env:
          APPIMAGE_EXTRACT_AND_RUN: "1"
        run: |
          appimage-builder --recipe AppImageBuilder.yml
        # -------------------------------------------------
        #   alternativ (wenn du das Flag bevorzugst):
        # run: |
        #   appimage-builder --no-fuse --recipe AppImageBuilder.yml
        # -------------------------------------------------

      # -------------------------------------------------
      # 6Ô∏è‚É£ Artefakt hochladen
      # -------------------------------------------------
      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: zaehlerstaende-appimage
          path: "*.AppImage"